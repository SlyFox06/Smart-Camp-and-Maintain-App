generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  phone         String?
  role          String         // 'student', 'technician', 'admin'
  department    String?
  avatar        String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  complaints    Complaint[]    @relation("StudentComplaints")
  assignments   Complaint[]    @relation("TechnicianAssignments")
  notifications Notification[]
  auditLogs     AuditLog[]
}

model Asset {
  id               String      @id @default(uuid())
  name             String
  type             String      // 'projector', 'ac', 'computer', 'light', 'water_cooler', 'other'
  building         String
  floor            String
  room             String
  department       String
  qrUrl            String?
  status           String      @default("operational") // 'operational', 'under_maintenance', 'faulty'
  installationDate DateTime    @default(now())
  lastMaintenance  DateTime?
  complaints       Complaint[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

model Complaint {
  id             String         @id @default(uuid())
  asset          Asset          @relation(fields: [assetId], references: [id])
  assetId        String
  student        User           @relation("StudentComplaints", fields: [studentId], references: [id])
  studentId      String
  technician     User?          @relation("TechnicianAssignments", fields: [technicianId], references: [id])
  technicianId   String?
  title          String
  description    String
  status         String         @default("reported") // 'reported', 'assigned', 'in_progress', 'resolved', 'closed'
  severity       String         @default("medium")   // 'low', 'medium', 'high', 'critical'
  images         String?        // JSON stringified array of URLs
  video          String?
  otp            String?
  otpVerified    Boolean        @default(false)
  repairEvidence String?
  assignedAt     DateTime?
  resolvedAt     DateTime?
  closedAt       DateTime?
  statusHistory  StatusUpdate[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model StatusUpdate {
  id          String    @id @default(uuid())
  complaint   Complaint @relation(fields: [complaintId], references: [id])
  complaintId String
  status      String
  updatedBy   String
  notes       String?
  timestamp   DateTime  @default(now())
}

model Notification {
  id                 String   @id @default(uuid())
  user               User     @relation(fields: [userId], references: [id])
  userId             String
  type               String
  title              String
  message            String
  read               Boolean  @default(false)
  relatedComplaintId String?
  createdAt          DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  action    String
  details   String
  timestamp DateTime @default(now())
}
