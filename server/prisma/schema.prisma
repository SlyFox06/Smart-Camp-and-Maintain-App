generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                 String         @db.VarChar(255)
  email                String         @unique @db.VarChar(255)
  password             String         @db.VarChar(255)
  role                 String         @db.VarChar(50)
  department           String?        @db.VarChar(100)
  avatar               String?
  phone                String?        @db.VarChar(20)
  isFirstLogin         Boolean?       @default(true) @map("is_first_login")
  createdAt            DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  auditLogs            AuditLog[]
  studentsComplaints   Complaint[]    @relation("StudentComplaints")
  technicianComplaints Complaint[]    @relation("TechnicianComplaints")
  notifications        Notification[]
  technician           Technician?

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model Asset {
  id         String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name       String      @db.VarChar(255)
  type       String      @db.VarChar(100)
  status     String?     @default("operational") @db.VarChar(50)
  building   String      @db.VarChar(100)
  floor      String      @db.VarChar(50)
  room       String      @db.VarChar(50)
  department String      @db.VarChar(100)
  qrUrl      String?     @map("qr_url")
  createdAt  DateTime?   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime?   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  complaints Complaint[]

  @@index([status], map: "idx_assets_status")
  @@map("assets")
}

model Complaint {
  id              String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title           String          @db.VarChar(255)
  description     String
  status          String?         @default("reported") @db.VarChar(50)
  severity        String?         @default("medium") @db.VarChar(50)
  images          String?
  video           String?
  otp             String?         @db.VarChar(10)
  otpVerified     Boolean?        @default(false) @map("otp_verified")
  rejectionReason String?         @map("rejection_reason")
  studentId       String          @map("student_id") @db.Uuid
  technicianId    String?         @map("technician_id") @db.Uuid
  assetId         String          @map("asset_id") @db.Uuid
  assignedAt      DateTime?       @map("assigned_at") @db.Timestamptz(6)
  resolvedAt      DateTime?       @map("resolved_at") @db.Timestamptz(6)
  createdAt       DateTime?       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime?       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  asset           Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  student         User            @relation("StudentComplaints", fields: [studentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  technician      User?           @relation("TechnicianComplaints", fields: [technicianId], references: [id], onUpdate: NoAction)
  notifications   Notification[]
  statusHistory   StatusHistory[]

  @@index([assetId], map: "idx_complaints_asset")
  @@index([status], map: "idx_complaints_status")
  @@index([studentId], map: "idx_complaints_student")
  @@index([technicianId], map: "idx_complaints_technician")
  @@map("complaints")
}

model Technician {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String    @unique @map("user_id") @db.Uuid
  skillType         String    @map("skill_type") @db.VarChar(100)
  assignedArea      String?   @map("assigned_area") @db.VarChar(100)
  isAvailable       Boolean?  @default(true) @map("is_available")
  temporaryPassword String?   @map("temporary_password") @db.VarChar(255)
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("technicians")
}

model StatusHistory {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  complaintId String    @map("complaint_id") @db.Uuid
  status      String    @db.VarChar(50)
  message     String?
  timestamp   DateTime? @default(now()) @db.Timestamptz(6)
  complaint   Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([complaintId], map: "idx_status_history_complaint")
  @@map("status_history")
}

model Notification {
  id                 String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId             String     @map("user_id") @db.Uuid
  title              String     @db.VarChar(255)
  message            String
  type               String     @db.VarChar(50)
  isRead             Boolean?   @default(false) @map("is_read")
  relatedComplaintId String?    @map("related_complaint_id") @db.Uuid
  createdAt          DateTime?  @default(now()) @map("created_at") @db.Timestamptz(6)
  relatedComplaint   Complaint? @relation(fields: [relatedComplaintId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId, isRead], map: "idx_notifications_unread")
  @@index([userId], map: "idx_notifications_user")
  @@map("notifications")
}

model AuditLog {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  action    String    @db.VarChar(100)
  details   String?
  timestamp DateTime? @default(now()) @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_audit_logs_user")
  @@map("audit_logs")
}
